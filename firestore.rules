rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Funciones de ayuda para la reutilización de lógica de seguridad
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner() {
      // El usuario es propietario si existe un documento en /owners con su UID
      return exists(/databases/$(database)/documents/owners/$(request.auth.uid));
    }

    function isClient(clientId) {
      // El usuario es el cliente especificado si su UID coincide
      return request.auth.uid == clientId;
    }

    // Reglas para la colección 'owners'
    match /owners/{ownerId} {
      // Solo el propietario puede leer/escribir en la colección de propietarios
      allow read, write: if isOwner();
    }

    // Reglas para la colección 'clients'
    match /clients/{clientId} {
      // El propietario puede leer/escribir. El cliente puede leer sus propios datos.
      allow read: if isOwner() || isClient(clientId);
      allow write: if isOwner();
    }

    // Reglas para la colección 'projects'
    match /projects/{projectId} {
      // Permitir lectura si:
      // 1. Es el propietario.
      // 2. El proyecto es del tipo 'portfolio'.
      // 3. El usuario es el cliente al que está asignado el proyecto.
      allow read: if isOwner() || resource.data.type == 'portfolio' || (resource.data.clientId != null && isClient(resource.data.clientId));
      
      // Permitir escritura (crear, actualizar, eliminar) solo al propietario
      allow write: if isOwner();
    }
    
    match /clients/{clientId}/projects/{projectId} {
        allow read, write: if isOwner() || isClient(clientId);
    }

    // Reglas para los tickets
    match /tickets/{ticketId} {
      allow read, write: if isOwner() || (isSignedIn() && resource.data.clientId == request.auth.uid);
      match /comments/{commentId} {
        allow read, write: if isOwner() || (isSignedIn() && resource.data.authorId == request.auth.uid);
      }
    }

    // Reglas para las facturas
    match /invoices/{invoiceId} {
      allow read, write: if isOwner() || (isSignedIn() && resource.data.clientId == request.auth.uid);
    }
    
    // Reglas para la configuración
    match /settings/{docId} {
      // Cualquiera puede leer la configuración del sitio o de "about". Solo el propietario puede escribir.
      allow read: if true;
      allow write: if isOwner();
    }

    // Reglas para los envíos del formulario de contacto
    match /contactFormSubmissions/{submissionId} {
      // Cualquiera puede crear (enviar el formulario)
      allow create: if true;
      // Solo el propietario puede leer, actualizar o eliminar envíos
      allow read, update, delete: if isOwner();
    }
  }
}
